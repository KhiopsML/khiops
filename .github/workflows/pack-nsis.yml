---
name: Windows Installer
on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**CMakeLists.txt'
      - packaging/windows/nsis/*.nsh
      - packaging/windows/nsis/*.nsi
      - .github/workflows/pack-nsis.yml
  push:
    tags: [v*]
# Cancel any ongoing run of this workflow on the same PR or ref
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref
    }}
  cancel-in-progress: true
jobs:
  build:
    outputs:
      khiops-version: ${{ steps.get-version.outputs.khiops-version }}
    runs-on: windows-latest
    steps:
      - name: Obtain checkout ref
        shell: bash
        run: |
          # We take the "pull request head" ref (by default it is a merged one)
          if [[ "${{ github.event_name }}" == "pull_request" ]]
          then
            CHECKOUT_REF="${{ github.event.pull_request.head.sha }}"
          # Otherwise the default checkout action ref
          else
            CHECKOUT_REF="${{ github.ref_name }}"
          fi
          echo "CHECKOUT_REF=$CHECKOUT_REF" >> $GITHUB_ENV
          echo "Checkout ref: $CHECKOUT_REF"
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}
      - name: Put the package version on the environment and output
        id: get-version
        shell: bash
        run: |
          # Build the versions
          KHIOPS_VERSION="$(./scripts/khiops-version)"
          KHIOPS_REDUCED_VERSION="$(echo $KHIOPS_VERSION | cut -d'-' -f1)"
          echo "KHIOPS_VERSION=$KHIOPS_VERSION" >> "$GITHUB_ENV"
          echo "KHIOPS_REDUCED_VERSION=$KHIOPS_REDUCED_VERSION" >> "$GITHUB_ENV"
          echo "khiops-version=$KHIOPS_VERSION" >> "$GITHUB_OUTPUT"
      - name: Download Windows install assets
        uses: robinraju/release-downloader@v1.9
        with:
          repository: khiopsml/khiops-win-install-assets
          latest: true
      - name: Extract Windows installer assets and load assets-info.env
        shell: bash
        run: |
          assets_tar_gz=$(ls khiops-win-install-assets*.tar.gz)
          tar -zxvf "$assets_tar_gz"
          cat assets/assets-info.env >> "$GITHUB_ENV"
      - name: Build the Khiops Binaries
        uses: ./.github/actions/build-khiops
        with:
          preset-name: windows-msvc-release
          targets: MODL MODL_Coclustering norm_jar khiops_jar
          override-flags: -DTESTING=OFF -DBUILD_JARS=ON
      - name: Build NSIS package
        shell: pwsh
        run: |-
          cd ./packaging/windows/nsis
          makensis `
            /DKHIOPS_VERSION=${{ env.KHIOPS_VERSION }} `
            /DKHIOPS_REDUCED_VERSION=${{ env.KHIOPS_REDUCED_VERSION }} `
            /DKHIOPS_WINDOWS_BUILD_DIR=..\..\..\build\windows-msvc-release `
            /DJRE_INSTALLER_PATH=..\..\..\assets\${{ env.JRE_FILENAME }} `
            /DJRE_VERSION=${{ env.JRE_VERSION }} `
            /DMSMPI_INSTALLER_PATH=..\..\..\assets\${{ env.MSMPI_FILENAME }} `
            /DMSMPI_VERSION=${{ env.MSMPI_VERSION }} `
            /DKHIOPS_VIZ_INSTALLER_PATH=..\..\..\assets\${{ env.KHIOPS_VIZ_FILENAME }} `
            /DKHIOPS_COVIZ_INSTALLER_PATH=..\..\..\assets\${{ env.KHIOPS_COVIZ_FILENAME }} `
            /DKHIOPS_SAMPLES_DIR=..\..\..\assets\samples `
            /DKHIOPS_DOC_DIR=..\..\..\assets\doc `
            khiops.nsi
      - name: Upload the Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: khiops-setup
          path: ./packaging/windows/nsis/khiops-${{ env.KHIOPS_VERSION }}-setup.exe
  test:
    needs: build
    runs-on: windows-2019
    steps:
      - name: Download NSIS installer artifact
        uses: actions/download-artifact@v4
        with:
          name: khiops-setup
      - name: Install Khiops
        shell: pwsh
        run: |
          # Execute the installer
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          Start-Process `
            -FilePath .\khiops-${{ needs.build.outputs.khiops-version }}-setup.exe `
            -ArgumentList '/S' `
            -Wait
          # Add Khiops and MPI to the path
          $Env:Path += ";${Env:ProgramFiles}\khiops\bin;${Env:ProgramFiles}\Microsoft MPI\Bin"
          echo "PATH=${Env:PATH}" >> ${Env:GITHUB_ENV}
          echo ${Env:GITHUB_ENV}
          type ${Env:GITHUB_ENV}
      - name: Checkout the khiops sources
        uses: actions/checkout@v4
      - name: Test the installation
        uses: ./.github/actions/test-khiops-install
  # Release is only executed on tags
  release:
    if: github.ref_type == 'tag'
    needs: [build, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download NSIS installer artifact
        uses: actions/download-artifact@v4
        with:
          name: khiops-setup
      - name: Rename packages with tag version
        run: |
          SOURCE_VERSION="${{ needs.build.outputs.khiops-version }}"
          PKG_FILE=$(ls *-setup.exe)
          NEW_PKG_FILE=$(echo $PKG_FILE | sed "s/-${SOURCE_VERSION}-/-${{ github.ref_name }}-/")
          mv $PKG_FILE $NEW_PKG_FILE
      - name: Upload NSIS installer to the release
        uses: ncipollo/release-action@v1.14.0
        with:
          allowUpdates: true
          artifacts: khiops-*-setup.exe
          body: '**For testing purposes only**'
          draft: false
          makeLatest: false
          prerelease: true
          updateOnlyUnreleased: true
